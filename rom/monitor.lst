 AS V1.42 Beta [Bld 295] - Source File monitor.asm - Page 1 - 12/03/2025 19:52:47


    1/   0 :                            ; monitor.asm - Intel 8080 Monitor ROM
    2/   0 :                            ; Assemble with: make
    3/   0 :                            ; 
    4/   0 :                            ; Memory Map:
    5/   0 :                            ;   0x0000-0x00FF: System workspace (RAM)
    6/   0 :                            ;   0x0100-0xEFFF: User program area (RAM)
    7/   0 :                            ;   0xF000-0xFFFF: Monitor ROM (this file)
    8/   0 :                            ;
    9/   0 :                            ; I/O Ports:
   10/   0 :                            ;   0x00: Console data (read/write)
   11/   0 :                            ;   0x01: Console status (bit 0 = input ready, bit 1 = output ready)
   12/   0 :                            
   13/   0 :                                    CPU     8080
   14/F000 :                                    ORG     0F000H
   15/F000 :                            
   16/F000 :                            ; ============================================
   17/F000 :                            ; CONSTANTS
   18/F000 :                            ; ============================================
   19/F000 :                            
   20/F000 : =0H                        CONSOLE_DATA    EQU     00H
   21/F000 : =1H                        CONSOLE_STATUS  EQU     01H
   22/F000 :                            
   23/F000 : =0F000H                    STACK_TOP       EQU     0F000H      ; Stack grows down from ROM
   24/F000 :                            
   25/F000 : =0DH                       CR              EQU     0DH
   26/F000 : =0AH                       LF              EQU     0AH
   27/F000 : =8H                        BS              EQU     08H
   28/F000 : =20H                       SPACE           EQU     20H
   29/F000 :                            
   30/F000 :                            ; ============================================
   31/F000 :                            ; WORKSPACE (RAM at 0x0080-0x00FF)
   32/F000 :                            ; ============================================
   33/F000 :                            
   34/F000 : =80H                       LINE_BUFFER     EQU     0080H       ; 80 bytes for command line
   35/F000 : =32H                       LINE_LENGTH     EQU     50          ; Max 80 chars
   36/F000 : =0D0H                      BUFFER_PTR      EQU     00D0H       ; Current position in buffer (2 bytes)
   37/F000 : =0D2H                      LAST_DUMP_ADDR  EQU     00D2H       ; Last dump address (2 bytes)
   38/F000 :                            
   39/F000 :                            ; ============================================
   40/F000 :                            ; COLD START
   41/F000 :                            ; ============================================
   42/F000 :                            
   43/F000 :                            COLD_START:
   44/F000 : 31 00 F0                           LXI     SP,STACK_TOP        ; Initialize stack pointer
   45/F003 :                                    
   46/F003 :                                    ; Initialize workspace
   47/F003 : 21 00 00                           LXI     H,0000H
   48/F006 : 22 D2 00                           SHLD    LAST_DUMP_ADDR      ; Default dump address = 0
   49/F009 :                                    
   50/F009 : CD 95 F0                           CALL    PRINT_BANNER        ; Show startup message
   51/F00C :                                    
   52/F00C :                            ; ============================================
   53/F00C :                            ; MAIN LOOP
   54/F00C :                            ; ============================================
   55/F00C :                            
   56/F00C :                            MAIN_LOOP:
   57/F00C : 3E 3E                              MVI     A,'>'               ; Print prompt
   58/F00E : CD 77 F0                           CALL    CONOUT
   59/F011 : 3E 20                              MVI     A,' '
   60/F013 : CD 77 F0                           CALL    CONOUT
 AS V1.42 Beta [Bld 295] - Source File monitor.asm - Page 2 - 12/03/2025 19:52:47


   61/F016 :                                    
   62/F016 : 3E 41                              MVI     A,'A'               ; DEBUG: before READ_LINE
   63/F018 : CD 77 F0                           CALL    CONOUT
   64/F01B :                                    
   65/F01B : CD DC F0                           CALL    READ_LINE           ; Read command into LINE_BUFFER
   66/F01E :                                    
   67/F01E : 3E 42                              MVI     A,'B'               ; DEBUG: after READ_LINE
   68/F020 : CD 77 F0                           CALL    CONOUT
   69/F023 : 76                                 HLT
   70/F024 :                            
   71/F024 :                            RL_DEBUG:
   72/F024 : 3E 58                              MVI     A,'X'
   73/F026 : CD 77 F0                           CALL    CONOUT
   74/F029 :                            
   75/F029 :                                            ; DEBUG: dump first 4 bytes of buffer
   76/F029 : 21 80 00                           LXI     H,LINE_BUFFER
   77/F02C : 7E                                 MOV     A,M
   78/F02D : CD B7 F0                           CALL    PRINT_HEX_BYTE
   79/F030 : 23                                 INX     H
   80/F031 : 7E                                 MOV     A,M
   81/F032 : CD B7 F0                           CALL    PRINT_HEX_BYTE
   82/F035 : 23                                 INX     H
   83/F036 : 7E                                 MOV     A,M
   84/F037 : CD B7 F0                           CALL    PRINT_HEX_BYTE
   85/F03A : 23                                 INX     H
   86/F03B : 7E                                 MOV     A,M
   87/F03C : CD B7 F0                           CALL    PRINT_HEX_BYTE
   88/F03F : CD A6 F0                           CALL    PRINT_CRLF
   89/F042 :                                    
   90/F042 : 21 80 00                           LXI     H,LINE_BUFFER       ; Point to start of buffer
   91/F045 : CD 38 F1                           CALL    SKIP_SPACES         ; Skip leading spaces
   92/F048 :                                    
   93/F048 : 7E                                 MOV     A,M                 ; Get command character
   94/F049 : B7                                 ORA     A                   ; Empty line?
   95/F04A : CA 0C F0                           JZ      MAIN_LOOP           ; Yes, just prompt again
   96/F04D :                                    
   97/F04D :                                    ; Convert to uppercase if lowercase
   98/F04D : FE 61                              CPI     'a'
   99/F04F : DA 59 F0                           JC      NOT_LOWER
  100/F052 : FE 7B                              CPI     'z'+1
  101/F054 : D2 59 F0                           JNC     NOT_LOWER
  102/F057 : D6 20                              SUI     20H                 ; Convert to uppercase
  103/F059 :                            NOT_LOWER:
  104/F059 :                                    
  105/F059 : 23                                 INX     H                   ; Point past command char
  106/F05A :                                    
  107/F05A :                                    ; Command dispatch
  108/F05A : FE 44                              CPI     'D'
  109/F05C : CA 9E F1                           JZ      CMD_DUMP
  110/F05F : FE 45                              CPI     'E'
  111/F061 : CA 45 F2                           JZ      CMD_EXAMINE
  112/F064 : FE 47                              CPI     'G'
  113/F066 : CA 4E F2                           JZ      CMD_GO
  114/F069 : FE 3F                              CPI     '?'
  115/F06B : CA 57 F2                           JZ      CMD_HELP
  116/F06E :                                    
  117/F06E :                                    ; Unknown command
  118/F06E : 21 7E F2                           LXI     H,MSG_UNKNOWN
  119/F071 : CD 9C F0                           CALL    PRINT_STRING
  120/F074 : C3 0C F0                           JMP     MAIN_LOOP
 AS V1.42 Beta [Bld 295] - Source File monitor.asm - Page 3 - 12/03/2025 19:52:47


  121/F077 :                            
  122/F077 :                            ; ============================================
  123/F077 :                            ; CONSOLE I/O ROUTINES
  124/F077 :                            ; ============================================
  125/F077 :                            
  126/F077 :                            ; CONOUT - Output character in A
  127/F077 :                            ; Preserves: all registers
  128/F077 :                            CONOUT:
  129/F077 : F5                                 PUSH    PSW
  130/F078 :                            CONOUT_WAIT:
  131/F078 : DB 01                              IN      CONSOLE_STATUS
  132/F07A : E6 02                              ANI     02H                 ; Check output ready bit
  133/F07C : CA 78 F0                           JZ      CONOUT_WAIT
  134/F07F : F1                                 POP     PSW
  135/F080 : D3 00                              OUT     CONSOLE_DATA
  136/F082 : C9                                 RET
  137/F083 :                            
  138/F083 :                            ; CONIN - Input character to A
  139/F083 :                            ; Trashes: flags
  140/F083 :                            CONIN:
  141/F083 : DB 01                              IN      CONSOLE_STATUS
  142/F085 : E6 01                              ANI     01H                 ; Check input ready bit
  143/F087 : CA 83 F0                           JZ      CONIN
  144/F08A : DB 00                              IN      CONSOLE_DATA
  145/F08C : C9                                 RET
  146/F08D :                            
  147/F08D :                            ; CONST - Console status
  148/F08D :                            ; Returns: A = 0xFF if char available, 0x00 if not
  149/F08D :                            ; Trashes: flags
  150/F08D :                            CONST:
  151/F08D : DB 01                              IN      CONSOLE_STATUS
  152/F08F : E6 01                              ANI     01H
  153/F091 : C8                                 RZ                          ; Return 0 if no char
  154/F092 : 3E FF                              MVI     A,0FFH              ; Return FF if char available
  155/F094 : C9                                 RET
  156/F095 :                            
  157/F095 :                            ; ============================================
  158/F095 :                            ; PRINT ROUTINES
  159/F095 :                            ; ============================================
  160/F095 :                            
  161/F095 :                            ; PRINT_BANNER - Display startup message
  162/F095 :                            PRINT_BANNER:
  163/F095 : 21 60 F2                           LXI     H,MSG_BANNER
  164/F098 : CD 9C F0                           CALL    PRINT_STRING
  165/F09B : C9                                 RET
  166/F09C :                            
  167/F09C :                            ; PRINT_STRING - Print null-terminated string at HL
  168/F09C :                            ; Trashes: A, HL, flags
  169/F09C :                            PRINT_STRING:
  170/F09C : 7E                                 MOV     A,M                 ; Get character
  171/F09D : B7                                 ORA     A                   ; Check for null
  172/F09E : C8                                 RZ                          ; Return if end of string
  173/F09F : CD 77 F0                           CALL    CONOUT
  174/F0A2 : 23                                 INX     H
  175/F0A3 : C3 9C F0                           JMP     PRINT_STRING
  176/F0A6 :                            
  177/F0A6 :                            ; PRINT_CRLF - Print carriage return and line feed
  178/F0A6 :                            ; Trashes: A, flags
  179/F0A6 :                            PRINT_CRLF:
  180/F0A6 : 3E 0D                              MVI     A,CR
 AS V1.42 Beta [Bld 295] - Source File monitor.asm - Page 4 - 12/03/2025 19:52:47


  181/F0A8 : CD 77 F0                           CALL    CONOUT
  182/F0AB : 3E 0A                              MVI     A,LF
  183/F0AD : CD 77 F0                           CALL    CONOUT
  184/F0B0 : C9                                 RET
  185/F0B1 :                            
  186/F0B1 :                            ; PRINT_SPACE - Print a space
  187/F0B1 :                            ; Trashes: A, flags
  188/F0B1 :                            PRINT_SPACE:
  189/F0B1 : 3E 20                              MVI     A,SPACE
  190/F0B3 : CD 77 F0                           CALL    CONOUT
  191/F0B6 : C9                                 RET
  192/F0B7 :                            
  193/F0B7 :                            ; PRINT_HEX_BYTE - Print A as two hex digits
  194/F0B7 :                            ; Input: A = byte to print
  195/F0B7 :                            ; Trashes: A, flags
  196/F0B7 :                            PRINT_HEX_BYTE:
  197/F0B7 : F5                                 PUSH    PSW                 ; Save original byte
  198/F0B8 : 0F                                 RRC                         ; Shift high nibble to low
  199/F0B9 : 0F                                 RRC
  200/F0BA : 0F                                 RRC
  201/F0BB : 0F                                 RRC
  202/F0BC : CD C4 F0                           CALL    PRINT_HEX_NIBBLE    ; Print high nibble
  203/F0BF : F1                                 POP     PSW                 ; Restore original
  204/F0C0 : CD C4 F0                           CALL    PRINT_HEX_NIBBLE    ; Print low nibble
  205/F0C3 : C9                                 RET
  206/F0C4 :                            
  207/F0C4 :                            ; PRINT_HEX_NIBBLE - Print low nibble of A as hex digit
  208/F0C4 :                            ; Input: A = value (low 4 bits used)
  209/F0C4 :                            ; Trashes: A, flags
  210/F0C4 :                            PRINT_HEX_NIBBLE:
  211/F0C4 : E6 0F                              ANI     0FH                 ; Mask to low nibble
  212/F0C6 : FE 0A                              CPI     0AH                 ; Is it A-F?
  213/F0C8 : DA CD F0                           JC      PHN_DIGIT           ; No, it's 0-9
  214/F0CB : C6 07                              ADI     07H                 ; Adjust for A-F
  215/F0CD :                            PHN_DIGIT:
  216/F0CD : C6 30                              ADI     '0'                 ; Convert to ASCII
  217/F0CF : CD 77 F0                           CALL    CONOUT
  218/F0D2 : C9                                 RET
  219/F0D3 :                            
  220/F0D3 :                            ; PRINT_HEX_WORD - Print HL as four hex digits
  221/F0D3 :                            ; Input: HL = word to print
  222/F0D3 :                            ; Trashes: A, flags
  223/F0D3 :                            PRINT_HEX_WORD:
  224/F0D3 : 7C                                 MOV     A,H
  225/F0D4 : CD B7 F0                           CALL    PRINT_HEX_BYTE
  226/F0D7 : 7D                                 MOV     A,L
  227/F0D8 : CD B7 F0                           CALL    PRINT_HEX_BYTE
  228/F0DB : C9                                 RET
  229/F0DC :                            
  230/F0DC :                            ; ============================================
  231/F0DC :                            ; INPUT ROUTINES
  232/F0DC :                            ; ============================================
  233/F0DC :                            
  234/F0DC :                            ; READ_LINE - Read line into LINE_BUFFER
  235/F0DC :                            ; Handles: BS (backspace), CR (end of line)
  236/F0DC :                            ; Returns: LINE_BUFFER contains null-terminated string
  237/F0DC :                            ; Trashes: A, B, HL, flags
  238/F0DC :                            READ_LINE:
  239/F0DC : 21 80 00                           LXI     H,LINE_BUFFER       ; Point to buffer start
  240/F0DF : 06 00                              MVI     B,0                 ; Character count
 AS V1.42 Beta [Bld 295] - Source File monitor.asm - Page 5 - 12/03/2025 19:52:47


  241/F0E1 :                                    
  242/F0E1 :                            RL_LOOP:
  243/F0E1 :                            
  244/F0E1 :                            ;DEBUG
  245/F0E1 : 3E 5B                              MVI     A,'['               ; DEBUG: prove we're here
  246/F0E3 : CD 77 F0                           CALL    CONOUT
  247/F0E6 :                            ;END DEBUG
  248/F0E6 : CD 83 F0                           CALL    CONIN               ; Get character
  249/F0E9 : 4F                                 MOV     C,A                 ; Save it in C
  250/F0EA :                            
  251/F0EA :                                    ;DEBUG
  252/F0EA : 3E 3E                              MVI     A,'>'               ; DEBUG: after CONIN
  253/F0EC : CD 77 F0                           CALL    CONOUT
  254/F0EF :                            
  255/F0EF :                                    ; DEBUG: print hex value of received char
  256/F0EF :                                    ;CALL    PRINT_HEX_BYTE
  257/F0EF :                                    ;MVI     A,'.'
  258/F0EF :                                    
  259/F0EF :                                    ;CALL    CONOUT
  260/F0EF : 79                                 MOV     A,C                 ; Restore char for comparison
  261/F0F0 :                            
  262/F0F0 : FE 0D                              CPI     CR                  ; Enter pressed?
  263/F0F2 : CA 2D F1                           JZ      RL_DONE
  264/F0F5 :                            
  265/F0F5 : FE 0A                              CPI     LF
  266/F0F7 : CA 2D F1                           JZ      RL_DONE
  267/F0FA :                                    
  268/F0FA : FE 08                              CPI     BS                  ; Backspace?
  269/F0FC : CA 14 F1                           JZ      RL_BACKSPACE
  270/F0FF :                                    
  271/F0FF : FE 20                              CPI     SPACE               ; Ignore control chars
  272/F101 : DA E1 F0                           JC      RL_LOOP
  273/F104 :                                    
  274/F104 :                                    ; Check buffer full
  275/F104 : 78                                 MOV     A,B
  276/F105 : FE 31                              CPI     LINE_LENGTH-1       ; Room for char + null?
  277/F107 : D2 E1 F0                           JNC     RL_LOOP             ; Buffer full, ignore
  278/F10A :                                    
  279/F10A :                                    ; Store and echo character
  280/F10A : 71                                 MOV     M,C                 ; Store in buffer
  281/F10B : 23                                 INX     H                   ; Advance pointer
  282/F10C : 04                                 INR     B                   ; Increment count
  283/F10D : 79                                 MOV     A,C                 ; Echo character
  284/F10E : CD 77 F0                           CALL    CONOUT
  285/F111 : C3 E1 F0                           JMP     RL_LOOP
  286/F114 :                                    
  287/F114 :                            RL_BACKSPACE:
  288/F114 : 78                                 MOV     A,B                 ; Check if buffer empty
  289/F115 : B7                                 ORA     A
  290/F116 : CA E1 F0                           JZ      RL_LOOP             ; Nothing to delete
  291/F119 :                                    
  292/F119 : 2B                                 DCX     H                   ; Back up pointer
  293/F11A : 05                                 DCR     B                   ; Decrement count
  294/F11B :                                    
  295/F11B :                                    ; Erase character on screen: BS, space, BS
  296/F11B : 3E 08                              MVI     A,BS
  297/F11D : CD 77 F0                           CALL    CONOUT
  298/F120 : 3E 20                              MVI     A,SPACE
  299/F122 : CD 77 F0                           CALL    CONOUT
  300/F125 : 3E 08                              MVI     A,BS
 AS V1.42 Beta [Bld 295] - Source File monitor.asm - Page 6 - 12/03/2025 19:52:47


  301/F127 : CD 77 F0                           CALL    CONOUT
  302/F12A : C3 E1 F0                           JMP     RL_LOOP
  303/F12D :                                    
  304/F12D :                            RL_DONE:
  305/F12D : 36 00                              MVI     M,0                 ; Null terminate
  306/F12F : CD A6 F0                           CALL    PRINT_CRLF          ; Echo newline
  307/F132 : 3E 5A                              MVI     A,'Z'               ; DEBUG: made it to end
  308/F134 : CD 77 F0                           CALL    CONOUT
  309/F137 : C9                                 RET
  310/F138 :                            
  311/F138 :                            ; ============================================
  312/F138 :                            ; PARSING ROUTINES
  313/F138 :                            ; ============================================
  314/F138 :                            
  315/F138 :                            ; SKIP_SPACES - Skip spaces in buffer
  316/F138 :                            ; Input: HL = pointer into buffer
  317/F138 :                            ; Output: HL = pointer to first non-space (or null)
  318/F138 :                            ; Trashes: A, flags
  319/F138 :                            SKIP_SPACES:
  320/F138 : 7E                                 MOV     A,M
  321/F139 : FE 20                              CPI     SPACE
  322/F13B : C0                                 RNZ                         ; Return if not a space
  323/F13C : 23                                 INX     H
  324/F13D : C3 38 F1                           JMP     SKIP_SPACES
  325/F140 :                            
  326/F140 :                            ; READ_HEX_WORD - Parse hex number from buffer
  327/F140 :                            ; Input: HL = pointer into buffer
  328/F140 :                            ; Output: DE = parsed value, HL = advanced past number
  329/F140 :                            ;         Carry set if no valid hex digits found
  330/F140 :                            ; Trashes: A, BC, flags
  331/F140 :                            READ_HEX_WORD:
  332/F140 : CD 38 F1                           CALL    SKIP_SPACES         ; Skip leading spaces
  333/F143 : 11 00 00                           LXI     D,0                 ; Initialize result
  334/F146 : 06 00                              MVI     B,0                 ; Digit count
  335/F148 :                                    
  336/F148 :                            RHW_LOOP:
  337/F148 : 7E                                 MOV     A,M                 ; Get character
  338/F149 : CD 74 F1                           CALL    TO_HEX_DIGIT        ; Convert to 0-15
  339/F14C : DA 6E F1                           JC      RHW_DONE            ; Not a hex digit, done
  340/F14F :                                    
  341/F14F :                                    ; Shift DE left 4 bits and add new digit
  342/F14F :                                    ; DE = DE * 16 + A
  343/F14F : F5                                 PUSH    PSW                 ; Save digit
  344/F150 :                                    
  345/F150 :                                    ; Shift DE left 4 bits
  346/F150 : 7A                                 MOV     A,D
  347/F151 : 07                                 RLC
  348/F152 : 07                                 RLC
  349/F153 : 07                                 RLC
  350/F154 : 07                                 RLC
  351/F155 : E6 F0                              ANI     0F0H
  352/F157 : 57                                 MOV     D,A
  353/F158 :                                    
  354/F158 : 7B                                 MOV     A,E
  355/F159 : 07                                 RLC
  356/F15A : 07                                 RLC
  357/F15B : 07                                 RLC
  358/F15C : 07                                 RLC
  359/F15D : 4F                                 MOV     C,A                 ; Save shifted E
  360/F15E : E6 F0                              ANI     0F0H
 AS V1.42 Beta [Bld 295] - Source File monitor.asm - Page 7 - 12/03/2025 19:52:47


  361/F160 : B2                                 ORA     D                   ; Combine with D bits
  362/F161 : 57                                 MOV     D,A
  363/F162 :                                    
  364/F162 : 79                                 MOV     A,C
  365/F163 : E6 0F                              ANI     0FH                 ; Low nibble of shifted E
  366/F165 : 5F                                 MOV     E,A
  367/F166 :                                    
  368/F166 : F1                                 POP     PSW                 ; Restore digit
  369/F167 : B3                                 ORA     E                   ; Add digit to low nibble
  370/F168 : 5F                                 MOV     E,A
  371/F169 :                                    
  372/F169 : 23                                 INX     H                   ; Advance buffer pointer
  373/F16A : 04                                 INR     B                   ; Count digit
  374/F16B : C3 48 F1                           JMP     RHW_LOOP
  375/F16E :                                    
  376/F16E :                            RHW_DONE:
  377/F16E : 78                                 MOV     A,B                 ; Check digit count
  378/F16F : B7                                 ORA     A
  379/F170 : 37                                 STC                         ; Set carry (no digits)
  380/F171 : C8                                 RZ                          ; Return with carry if no digits
  381/F172 : B7                                 ORA     A                   ; Clear carry (success)
  382/F173 : C9                                 RET
  383/F174 :                            
  384/F174 :                            ; TO_HEX_DIGIT - Convert ASCII to hex value
  385/F174 :                            ; Input: A = ASCII character
  386/F174 :                            ; Output: A = hex value (0-15), Carry clear
  387/F174 :                            ;         Carry set if not a hex digit
  388/F174 :                            ; Trashes: flags
  389/F174 :                            TO_HEX_DIGIT:
  390/F174 : FE 30                              CPI     '0'
  391/F176 : DA 9C F1                           JC      THD_FAIL            ; Below '0'
  392/F179 : FE 3A                              CPI     '9'+1
  393/F17B : DA 98 F1                           JC      THD_DIGIT           ; '0'-'9'
  394/F17E :                                    
  395/F17E : FE 41                              CPI     'A'
  396/F180 : DA 9C F1                           JC      THD_FAIL            ; Between '9' and 'A'
  397/F183 : FE 47                              CPI     'F'+1
  398/F185 : DA 94 F1                           JC      THD_ALPHA           ; 'A'-'F'
  399/F188 :                                    
  400/F188 : FE 61                              CPI     'a'
  401/F18A : DA 9C F1                           JC      THD_FAIL            ; Between 'F' and 'a'
  402/F18D : FE 67                              CPI     'f'+1
  403/F18F : D2 9C F1                           JNC     THD_FAIL            ; Above 'f'
  404/F192 :                                    
  405/F192 :                                    ; 'a'-'f': convert to uppercase first
  406/F192 : D6 20                              SUI     20H
  407/F194 :                                    
  408/F194 :                            THD_ALPHA:
  409/F194 : D6 37                              SUI     'A'-10              ; Convert 'A'-'F' to 10-15
  410/F196 : B7                                 ORA     A                   ; Clear carry
  411/F197 : C9                                 RET
  412/F198 :                                    
  413/F198 :                            THD_DIGIT:
  414/F198 : D6 30                              SUI     '0'                 ; Convert '0'-'9' to 0-9
  415/F19A : B7                                 ORA     A                   ; Clear carry
  416/F19B : C9                                 RET
  417/F19C :                                    
  418/F19C :                            THD_FAIL:
  419/F19C : 37                                 STC                         ; Set carry = not hex
  420/F19D : C9                                 RET
 AS V1.42 Beta [Bld 295] - Source File monitor.asm - Page 8 - 12/03/2025 19:52:47


  421/F19E :                            
  422/F19E :                            ; ============================================
  423/F19E :                            ; COMMANDS
  424/F19E :                            ; ============================================
  425/F19E :                            
  426/F19E :                            ; CMD_DUMP - Dump memory
  427/F19E :                            ; Syntax: D [start] [end]
  428/F19E :                            ; If no args, continues from last address
  429/F19E :                            ; If one arg, dumps 128 bytes from start
  430/F19E :                            ; If two args, dumps from start to end
  431/F19E :                            CMD_DUMP:
  432/F19E :                            
  433/F19E : 3E 21                              MVI     A,'!'               ; DEBUG: Did we get here?
  434/F1A0 : CD 77 F0                           CALL    CONOUT
  435/F1A3 : CD A6 F0                           CALL    PRINT_CRLF
  436/F1A6 :                            
  437/F1A6 : CD 38 F1                           CALL    SKIP_SPACES
  438/F1A9 : 7E                                 MOV     A,M
  439/F1AA : B7                                 ORA     A                   ; End of line?
  440/F1AB : CA C7 F1                           JZ      CD_NO_ARGS
  441/F1AE :                                    
  442/F1AE :                                    ; Parse start address
  443/F1AE : CD 40 F1                           CALL    READ_HEX_WORD
  444/F1B1 : DA E1 F1                           JC      CD_ERROR            ; No valid address
  445/F1B4 : D5                                 PUSH    D                   ; Save start address
  446/F1B5 :                                    
  447/F1B5 : CD 38 F1                           CALL    SKIP_SPACES
  448/F1B8 : 7E                                 MOV     A,M
  449/F1B9 : B7                                 ORA     A                   ; End of line?
  450/F1BA : CA D5 F1                           JZ      CD_ONE_ARG
  451/F1BD :                                    
  452/F1BD :                                    ; Parse end address
  453/F1BD : CD 40 F1                           CALL    READ_HEX_WORD
  454/F1C0 : DA E0 F1                           JC      CD_POP_ERROR        ; Invalid end address
  455/F1C3 :                                    
  456/F1C3 :                                    ; Two args: start in stack, end in DE
  457/F1C3 : E1                                 POP     H                   ; HL = start
  458/F1C4 : C3 EA F1                           JMP     CD_DUMP_RANGE
  459/F1C7 :                                    
  460/F1C7 :                            CD_NO_ARGS:
  461/F1C7 :                                    ; Continue from last address
  462/F1C7 : 2A D2 00                           LHLD    LAST_DUMP_ADDR
  463/F1CA : 11 7F 00                           LXI     D,007FH             ; 128 bytes
  464/F1CD : 19                                 DAD     D                   ; HL = start, calculate end
  465/F1CE : EB                                 XCHG                        ; DE = end
  466/F1CF : 2A D2 00                           LHLD    LAST_DUMP_ADDR      ; HL = start
  467/F1D2 : C3 EA F1                           JMP     CD_DUMP_RANGE
  468/F1D5 :                                    
  469/F1D5 :                            CD_ONE_ARG:
  470/F1D5 : E1                                 POP     H                   ; HL = start
  471/F1D6 : E5                                 PUSH    H                   ; Save start again
  472/F1D7 : 11 7F 00                           LXI     D,007FH
  473/F1DA : 19                                 DAD     D                   ; HL = start + 127 = end
  474/F1DB : EB                                 XCHG                        ; DE = end
  475/F1DC : E1                                 POP     H                   ; HL = start
  476/F1DD : C3 EA F1                           JMP     CD_DUMP_RANGE
  477/F1E0 :                                    
  478/F1E0 :                            CD_POP_ERROR:
  479/F1E0 : D1                                 POP     D                   ; Clean up stack
  480/F1E1 :                            CD_ERROR:
 AS V1.42 Beta [Bld 295] - Source File monitor.asm - Page 9 - 12/03/2025 19:52:47


  481/F1E1 : 21 A2 F2                           LXI     H,MSG_BAD_ADDR
  482/F1E4 : CD 9C F0                           CALL    PRINT_STRING
  483/F1E7 : C3 0C F0                           JMP     MAIN_LOOP
  484/F1EA :                            
  485/F1EA :                            ; CD_DUMP_RANGE - Dump memory from HL to DE
  486/F1EA :                            ; Input: HL = start address, DE = end address
  487/F1EA :                            CD_DUMP_RANGE:
  488/F1EA : D5                                 PUSH    D                   ; Save end address
  489/F1EB :                            
  490/F1EB :                            CD_LINE:
  491/F1EB :                                    ; Print address
  492/F1EB : CD D3 F0                           CALL    PRINT_HEX_WORD
  493/F1EE : 3E 3A                              MVI     A,':'
  494/F1F0 : CD 77 F0                           CALL    CONOUT
  495/F1F3 : CD B1 F0                           CALL    PRINT_SPACE
  496/F1F6 :                                    
  497/F1F6 :                                    ; Print 16 hex bytes
  498/F1F6 : E5                                 PUSH    H                   ; Save line start for ASCII
  499/F1F7 : 0E 10                              MVI     C,16                ; Byte counter
  500/F1F9 :                                    
  501/F1F9 :                            CD_HEX_BYTE:
  502/F1F9 : 7E                                 MOV     A,M                 ; Get byte
  503/F1FA : CD B7 F0                           CALL    PRINT_HEX_BYTE
  504/F1FD : CD B1 F0                           CALL    PRINT_SPACE
  505/F200 :                                    
  506/F200 :                                    ; Extra space after 8th byte
  507/F200 : 79                                 MOV     A,C
  508/F201 : FE 09                              CPI     9
  509/F203 : C2 09 F2                           JNZ     CD_NO_GAP
  510/F206 : CD B1 F0                           CALL    PRINT_SPACE
  511/F209 :                            CD_NO_GAP:
  512/F209 :                                    
  513/F209 : 23                                 INX     H
  514/F20A : 0D                                 DCR     C
  515/F20B : C2 F9 F1                           JNZ     CD_HEX_BYTE
  516/F20E :                                    
  517/F20E :                                    ; Print ASCII representation
  518/F20E : CD B1 F0                           CALL    PRINT_SPACE
  519/F211 : E1                                 POP     H                   ; Restore line start
  520/F212 : 0E 10                              MVI     C,16
  521/F214 :                                    
  522/F214 :                            CD_ASCII:
  523/F214 : 7E                                 MOV     A,M
  524/F215 : FE 20                              CPI     SPACE               ; Printable? (>= 0x20)
  525/F217 : DA 1F F2                           JC      CD_DOT
  526/F21A : FE 7F                              CPI     07FH                ; Printable? (< 0x7F)
  527/F21C : DA 21 F2                           JC      CD_PRINT_CHAR
  528/F21F :                            CD_DOT:
  529/F21F : 3E 2E                              MVI     A,'.'
  530/F221 :                            CD_PRINT_CHAR:
  531/F221 : CD 77 F0                           CALL    CONOUT
  532/F224 : 23                                 INX     H
  533/F225 : 0D                                 DCR     C
  534/F226 : C2 14 F2                           JNZ     CD_ASCII
  535/F229 :                                    
  536/F229 : CD A6 F0                           CALL    PRINT_CRLF
  537/F22C :                                    
  538/F22C :                                    ; Check if done (HL > end address)
  539/F22C : D1                                 POP     D                   ; DE = end address
  540/F22D : D5                                 PUSH    D                   ; Keep it on stack
 AS V1.42 Beta [Bld 295] - Source File monitor.asm - Page 10 - 12/03/2025 19:52:47


  541/F22E :                                    
  542/F22E :                                    ; Compare HL to DE
  543/F22E : 7C                                 MOV     A,H
  544/F22F : BA                                 CMP     D
  545/F230 : DA EB F1                           JC      CD_LINE             ; H < D, continue
  546/F233 : C2 3E F2                           JNZ     CD_DONE             ; H > D, done
  547/F236 : 7D                                 MOV     A,L
  548/F237 : BB                                 CMP     E
  549/F238 : DA EB F1                           JC      CD_LINE             ; L < E, continue
  550/F23B : CA EB F1                           JZ      CD_LINE             ; L == E, do one more line... 
  551/F23E :                                                                ; Actually should stop. Let me think.
  552/F23E :                                    ; If HL > DE, we're done
  553/F23E :                                    ; If HL <= DE, continue
  554/F23E :                                    
  555/F23E :                            CD_DONE:
  556/F23E : D1                                 POP     D                   ; Clean up stack
  557/F23F : 22 D2 00                           SHLD    LAST_DUMP_ADDR      ; Save for next time
  558/F242 : C3 0C F0                           JMP     MAIN_LOOP
  559/F245 :                            
  560/F245 :                            ; CMD_EXAMINE - Placeholder
  561/F245 :                            CMD_EXAMINE:
  562/F245 : 21 B4 F2                           LXI     H,MSG_NOT_IMPL
  563/F248 : CD 9C F0                           CALL    PRINT_STRING
  564/F24B : C3 0C F0                           JMP     MAIN_LOOP
  565/F24E :                            
  566/F24E :                            ; CMD_GO - Placeholder
  567/F24E :                            CMD_GO:
  568/F24E : 21 B4 F2                           LXI     H,MSG_NOT_IMPL
  569/F251 : CD 9C F0                           CALL    PRINT_STRING
  570/F254 : C3 0C F0                           JMP     MAIN_LOOP
  571/F257 :                            
  572/F257 :                            ; CMD_HELP - Show help
  573/F257 :                            CMD_HELP:
  574/F257 : 21 C6 F2                           LXI     H,MSG_HELP
  575/F25A : CD 9C F0                           CALL    PRINT_STRING
  576/F25D : C3 0C F0                           JMP     MAIN_LOOP
  577/F260 :                            
  578/F260 :                            ; ============================================
  579/F260 :                            ; STRINGS
  580/F260 :                            ; ============================================
  581/F260 :                            
  582/F260 :                            MSG_BANNER:
  583/F260 : 0D 0A                              DB      CR,LF
  584/F262 : 38 30 38 30 20 4D 6F 6E 69         DB      "8080 Monitor v0.1",CR,LF
      F26B : 74 6F 72 20 76 30 2E 31 0D
      F274 : 0A                        
  585/F275 : 52 65 61 64 79 2E 0D 0A            DB      "Ready.",CR,LF
  586/F27D : 00                                 DB      0
  587/F27E :                            
  588/F27E :                            MSG_UNKNOWN:
  589/F27E : 55 6E 6B 6E 6F 77 6E 20 63         DB      "Unknown command. Type ? for help.",CR,LF,0
      F287 : 6F 6D 6D 61 6E 64 2E 20 54
      F290 : 79 70 65 20 3F 20 66 6F 72
      F299 : 20 68 65 6C 70 2E 0D 0A 00
  590/F2A2 :                            
  591/F2A2 :                            MSG_BAD_ADDR:
  592/F2A2 : 49 6E 76 61 6C 69 64 20 61         DB      "Invalid address",CR,LF,0
      F2AB : 64 64 72 65 73 73 0D 0A 00
  593/F2B4 :                            
  594/F2B4 :                            MSG_NOT_IMPL:
 AS V1.42 Beta [Bld 295] - Source File monitor.asm - Page 11 - 12/03/2025 19:52:47


  595/F2B4 : 4E 6F 74 20 69 6D 70 6C 65         DB      "Not implemented",CR,LF,0
      F2BD : 6D 65 6E 74 65 64 0D 0A 00
  596/F2C6 :                            
  597/F2C6 :                            MSG_HELP:
  598/F2C6 : 43 6F 6D 6D 61 6E 64 73 3A         DB      "Commands:",CR,LF
      F2CF : 0D 0A                     
  599/F2D1 : 20 20 44 20 5B 73 74 61 72         DB      "  D [start] [end]  - Dump memory",CR,LF
      F2DA : 74 5D 20 5B 65 6E 64 5D 20
      F2E3 : 20 2D 20 44 75 6D 70 20 6D
      F2EC : 65 6D 6F 72 79 0D 0A      
  600/F2F3 : 20 20 45 20 5B 61 64 64 72         DB      "  E [addr]         - Examine/modify",CR,LF
      F2FC : 5D 20 20 20 20 20 20 20 20
      F305 : 20 2D 20 45 78 61 6D 69 6E
      F30E : 65 2F 6D 6F 64 69 66 79 0D
      F317 : 0A                        
  601/F318 : 20 20 47 20 5B 61 64 64 72         DB      "  G [addr]         - Go (execute)",CR,LF
      F321 : 5D 20 20 20 20 20 20 20 20
      F32A : 20 2D 20 47 6F 20 28 65 78
      F333 : 65 63 75 74 65 29 0D 0A   
  602/F33B : 20 20 3F 20 20 20 20 20 20         DB      "  ?                - Help",CR,LF
      F344 : 20 20 20 20 20 20 20 20 20
      F34D : 20 2D 20 48 65 6C 70 0D 0A
  603/F356 : 00                                 DB      0
  604/F357 :                            
  605/F357 :                            ; ============================================
  606/F357 :                            ; PADDING
  607/F357 :                            ; ============================================
  608/F357 :                            
  609/F357 : =>FALSE                            IF      $ > 0FFFFH
  610/F357 :                                    ERROR   "ROM exceeds 4KB!"
  611/F357 : [609]                              ENDIF
  612/F357 :                            
  613/F357 :                                    END     COLD_START
 AS V1.42 Beta [Bld 295] - Source File monitor.asm - Page 12 - 12/03/2025 19:52:47


  Symbol Table (* = unused):
  --------------------------

*ARCHITECTURE :                                      "aarch64-apple-darwin" - |
 BS :                             8 - | *BUFFER_PTR :                   0D0 - |
*CASESENSITIVE :                  0 - |  CD_ASCII :                   0F214 C |
 CD_DONE :                    0F23E C |  CD_DOT :                     0F21F C |
 CD_DUMP_RANGE :              0F1EA C |  CD_ERROR :                   0F1E1 C |
 CD_HEX_BYTE :                0F1F9 C |  CD_LINE :                    0F1EB C |
 CD_NO_ARGS :                 0F1C7 C |  CD_NO_GAP :                  0F209 C |
 CD_ONE_ARG :                 0F1D5 C |  CD_POP_ERROR :               0F1E0 C |
 CD_PRINT_CHAR :              0F221 C |  CMD_DUMP :                   0F19E C |
 CMD_EXAMINE :                0F245 C |  CMD_GO :                     0F24E C |
 CMD_HELP :                   0F257 C |  COLD_START :                 0F000 C |
 CONIN :                      0F083 C |  CONOUT :                     0F077 C |
 CONOUT_WAIT :                0F078 C |  CONSOLE_DATA :                   0 - |
 CONSOLE_STATUS :                 1 - | *CONST :                      0F08D C |
*CONSTPI :        3.141592653589793 - |  CR :                            0D - |
*DATE :                "12/03/2025" - | *FALSE :                          0 - |
*FLOATMAX :      1.797693134866E308 - | *HAS64 :                          1 - |
 LAST_DUMP_ADDR :               0D2 - |  LF :                            0A - |
 LINE_BUFFER :                   80 - |  LINE_LENGTH :                   32 - |
*LISTON :                         1 - | *MACEXP :                         7 - |
 MAIN_LOOP :                  0F00C C | *MOMCPU :                      8080 - |
*MOMCPUNAME :                "8080" - |  MSG_BAD_ADDR :               0F2A2 C |
 MSG_BANNER :                 0F260 C |  MSG_HELP :                   0F2C6 C |
 MSG_NOT_IMPL :               0F2B4 C |  MSG_UNKNOWN :                0F27E C |
*NESTMAX :                      100 - |  NOT_LOWER :                  0F059 C |
 PHN_DIGIT :                  0F0CD C |  PRINT_BANNER :               0F095 C |
 PRINT_CRLF :                 0F0A6 C |  PRINT_HEX_BYTE :             0F0B7 C |
 PRINT_HEX_NIBBLE :           0F0C4 C |  PRINT_HEX_WORD :             0F0D3 C |
 PRINT_SPACE :                0F0B1 C |  PRINT_STRING :               0F09C C |
 READ_HEX_WORD :              0F140 C |  READ_LINE :                  0F0DC C |
*RELAXED :                        0 - |  RHW_DONE :                   0F16E C |
 RHW_LOOP :                   0F148 C |  RL_BACKSPACE :               0F114 C |
*RL_DEBUG :                   0F024 C |  RL_DONE :                    0F12D C |
 RL_LOOP :                    0F0E1 C |  SKIP_SPACES :                0F138 C |
 SPACE :                         20 - |  STACK_TOP :                  0F000 - |
 THD_ALPHA :                  0F194 C |  THD_DIGIT :                  0F198 C |
 THD_FAIL :                   0F19C C | *TIME :                  "19:52:47" - |
 TO_HEX_DIGIT :               0F174 C | *TRUE :                           1 - |
*VERSION :                     142F - | *Z80SYNTAX :                      0 - |

     77 symbols
     20 unused symbols

 AS V1.42 Beta [Bld 295] - Source File monitor.asm - Page 13 - 12/03/2025 19:52:47


  Code Pages:
  ----------

STANDARD (0 changed characters)

1 code page

0.00 seconds assembly time

    613 lines source file
      2 passes
      0 errors
      0 warnings
